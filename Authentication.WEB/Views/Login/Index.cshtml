@model InsuredTraveling.Models.LoginUser

@{
    ViewBag.Title = "Login";
}

    <form method="post" id="loginForm" data-otf-ajax="true" action="@Url.Action("Index")">
        <div class="form-group">
            @Html.LabelFor(model => model.Username, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(model => model.Username, new { htmlAttributes = new { @class = "form-control" } })
                @Html.ValidationMessageFor(model => model.Username, "", new { @class = "text-danger" })
            </div>
        </div>

        <div class="form-group">
            @Html.LabelFor(model => model.Password, htmlAttributes: new { @class = "control-label col-md-2" })
            <div class="col-md-10">
                @Html.EditorFor(model => model.Password, new { htmlAttributes = new { @class = "form-control" } })
                @Html.ValidationMessageFor(model => model.Password, "", new { @class = "text-danger" })
            </div>
        </div>
        <br />
        <br />
        <div class="form-group">
            <div class="col-md-offset-2 col-md-10">
                <input type="submit" value="Log in" class="btn btn-success"" onclick="loginUser()" />
            </div>
        </div>
    </form>
<script type="text/javascript">

    function loginUser() {
        var ajaxFormSubmit = function () {
            var $form = $(this);
            var options = {
                url: $form.attr("action"),
                type: $form.attr("method"),
                data: $form.serialize()
            };
            $.ajax(options).done(function (data) {            
                var data1 = data.responseText.Data;
                //alert(data1.Username + " " + data1.Password);  
                $.ajax({
                            url: "http://localhost:19655/token",
                            type: "post",
                            data: jQuery.param({ grant_type: "password", username: data1.Username, password:data1.Password }),
                            contentType: 'application/x-www-form-urlencoded',
                            beforeSend: function (xhr) {
                                xhr.setRequestHeader('Accept', 'application/json');
                            },
                            success: function (response) {
                                //alert(response.access_token);
                                localStorage.setItem("token", response.access_token);
                                localStorage.setItem("username", response.userName);
                                
                                $.ajax({
                                    type: 'POST',
                                    url: "http://localhost:19655/Login/ReciveToken",
                                    data: jQuery.param({ token: localStorage.getItem("token")}),
                                    beforeSend: function (xhr) {
                                    },
                                    success: function () {
                                        window.location.replace("http://localhost:19655/home");
                                    },
                                    error: function () {
                                    }
                            });
                            },
                            error: function () {
                                alert("Username or password in not valid");
                            }
                });
                
            });
            return false;
        }
        $("form[data-otf-ajax='true']").submit(ajaxFormSubmit);
    };
</script>