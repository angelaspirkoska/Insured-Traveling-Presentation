@{HtmlHelper.UnobtrusiveJavaScriptEnabled = true;}
@model InsuredTravelingEntity
@{
    ViewBag.Title = "Search";
}

<br />
<br />

<div>
    <ul class="nav nav-pills">
        <li id="polycies" class="active"><a href="#" onclick="ShowPolycies()">Полиси</a></li>
        <li id="clients"><a href="#" onclick="ShowClients()">Клиенти</a></li>
        <li id="first_notice_of_loss"><a href="#" onclick="ShowFNOL()">Штети </a></li>
    </ul>

    <!--Table search result of policies -->
    <div class="container" id="searchPolycies">
        <br />
        <br />
        <div class="row">
            <form method="post" style="margin-left: 20px">
                <div class="row">
                    @*<input type="search" id="namePolicy" class="input-sm" placeholder="Search by name" />
                        <input type="search" id="embgPolicy" class="input-sm" placeholder="Search by EMBG" />
                        <input type="search" id="land" class="input-sm" placeholder="Search by Land" />
                        <input type="search" id="addressPolicy" class="input-sm" placeholder="Search by Address" />
                        <input type="search" id="agency" class="input-sm" placeholder="Search by Agency" />*@
                    <div class="form-inline row">
                        <div class="form-group col-sm-3">
                            <label for="vidPolisa">Вид полиса :</label>
                            <br />
                            @Html.DropDownListFor(model => model.policy_type, (List<SelectListItem>)ViewBag.TypeOfPolicy, "-- Type of policy --", new { @class = "form-control", name = "TypePolycies", id = "TypePolicy" })
                        </div>
                        <div class="form-group col-sm-3">
                            <label for="country">Земја на патување:</label>
                            @Html.DropDownListFor(model => model.countries, (List<SelectListItem>)ViewBag.Countries, "-- Country --", new { @class = "form-control", name = "Country", id = "Country" })
                        </div>
                    </div>
                    <div class="form-inline row">
                        <div class="form-group col-sm-3">
                            <label for="startDate">Датум на важење од:</label>
                            <input type="date" id="startDate" class="form-control placeholder" />
                            <select id="operatorStartDate">
                                <option>&lt</option>
                                <option>=</option>
                                <option>&gt</option>
                            </select>
                        </div>
                        <div class="form-group col-sm-3">
                            <label for="endDate">Датум на завршување на важење:</label>
                            <input type="date" name="endDate" class="form-control" id="endDate" />
                            <select id="operatorEndDate">
                                <option>&lt</option>
                                <option>=</option>
                                <option>&gt</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-inline row">
                        <div class="form-group col-sm-3">
                            <label for="startDate">Датум на издавање:</label>
                            <input type="date" class="form-control placeholder" id="dateI" />
                            <select id="operatorDateI">
                                <option>&lt</option>
                                <option>=</option>
                                <option>&gt</option>
                            </select>
                        </div>
                        <div class="form-group col-sm-3">
                            <label for="endDate">Датум на сторнирање:</label>
                            <input type="date" id="dateS" class="form-control" />
                            <select id="operatorDateS">
                                <option>&lt</option>
                                <option>=</option>
                                <option>&gt</option>
                            </select>
                        </div>
                    </div>

                </div>
                <br />
                <input id="btnSubmit" class="btn btn-primary btn-material-design-success" value="Search" onclick="SearchPolycies()" type="button" />
                <br />
            </form>
            <div class="row">
                <div class="col-md-offset-11 hover-tooltip">
                    <button type="button" class="btn btn-success btn-circle btn-lg btn-material-design" data-toggle="tooltip" title="Додади нова полиса" onclick="@("window.location.href='" + @Url.Action("Index", "Policy") + "'");"><i class="glyphicon glyphicon-plus"></i></button>
                </div>
            </div>
        </div>
        <br />
        <br />
        <br />
        <div class="row">
            <table style="width: 100%;" class="table table-bordered table-hover table-striped" id="tablePolicies">
                <thead>
                    <tr>
                        <th>Број на полиса</th>
                        <th>Земја на патување</th>
                        <th>Вид полиса</th>
                        <th>Важи од</th>
                        <th>Важи до</th>
                        <th>Датум на издавање</th>
                        <th>Датум на сторнирање</th>
                        <th></th>
                        <th></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="searchResultPolycies"></tbody>
            </table>
        </div>
        <br />
        <br />
        <div class="row">
            <table style="width: 100%;" class="table table-bordered table-hover table-striped" id="tableFNOLPolicies">
                <thead>
                    <tr>
                        <th>Број на полиса</th>
                        <th>Име и презиме на осигуреник</th>
                        <th>Име и презиме на оштетениот</th>
                        <th>Сродство на оштетениот со осигуреникот</th>
                        <th>Вкупна цена на трошоците</th>
                        <th>Датум на пријавување</th>
                        <th>Здраствено осигурување ДА/НЕ</th>
                        <th>Осигурување на багаж ДА/НЕ</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!--Table search result of clients -->
    <div class="container" id="searchClients">
        <br />
        <br />
        <div class="row">
            <form method="post" style="margin-left:20px;">
                <div class="row">
                    <div class="form-inline row">
                        <div class="form-group col-sm-3">
                            <input type="search" name="name" class="input-sm" placeholder="Search by name" id="name" />
                        </div>
                        <div class="form-group col-sm-3">
                            <input type="search" name="lastname" class="input-sm" placeholder="Search by Last Name" id="lastname" />
                        </div>
                        <div class="form-group col-sm-3">
                            <input type="search" name="embg" class="input-sm" placeholder="Search by EMBG" id="embg" />
                        </div>
                    </div>
                    <div class="form-inline row">
                        <div class="form-group col-sm-3">
                            <input type="search" name="address" class="input-sm" placeholder="Search by Address" id="address" />
                        </div>
                        <div class="form-group col-sm-3">
                            <input type="search" name="city" class="input-sm" placeholder="Search by City" id="city" />
                        </div>
                    </div>
                    <div class="form-inline row">
                        <div class="form-group col-sm-3">
                            <input type="search" name="postal_code" class="input-sm" placeholder="Search by postal code" id="postal_code" />
                        </div>
                        <div class="form-group col-sm-3">
                            <input type="search" name="phone" class="input-sm" placeholder="Search by phone number" id="phone" />
                        </div>
                    </div>
                    <div class="form-inline row">
                        <div class="form-group col-sm-3">
                            <input type="search" name="email" class="input-sm" placeholder="Search by email" id="email" />
                        </div>
                        <div class="form-group col-sm-3">
                            <input type="search" name="passport" class="input-sm" placeholder="Search by passport" id="passport" />
                        </div>
                    </div>
                </div>
                <br />
                <br />
            </form>
        </div>
        <br />
        <br />
        <br />
        <div class="row">
            <div class="col-md-12 hover-tooltip">
                <input id="btnSubmit" class="btn btn-primary btn-material-design-success" value="Search" onclick="SearchClients()" type="button" style="float:left;" />
                <button type="button" class="btn btn-success btn-circle btn-lg btn-material-design" data-toggle="tooltip" style="float:right;" title="Додади нов клиент" onclick="@("window.location.href='" + @Url.Action("Create", "Client") + "'");"><i class="glyphicon glyphicon-plus"></i></button>
            </div>
        </div>
        <br />
        <br />
        <br />

        <div class="row">
            <table style="width: 100%;" class="table table-bordered table-hover table-striped" id="tableClients">
                <thead>
                    <tr>
                        <th>Име</th>
                        <th>Презиме</th>
                        <th>Матичен број</th>
                        <th>Улица</th>
                        <th>Град</th>
                        <th>Поштенски број</th>
                        <th>Телефонски број</th>
                        <th>Емаил адресa</th>
                        <th>Број на пасош</th>
                    </tr>
                </thead>
                <tbody id="searchResultClients"></tbody>
            </table>
        </div>
    </div>

    <!--Table search result of first notice of loss -->
    <div class="container" id="searchFNOL">
        <br />
        <br />
        <div class="row" id="searchFNOLAttributes">
            <form method="post" style="margin-left: 20px">
                <div class="row">
                    <div class="form-inline row">
                        <div class="form-group col-sm-3">
                            <label for="vidPolisa">Број на полиса :</label>
                            <br />
                            @Html.DropDownListFor(model => model.travel_policy, (List<SelectListItem>)ViewBag.Policies, "-- Број на полиса --", new { @class = "form-control", name = "PolicyNumber", id = "PolicyNumber" })
                        </div>
                        <div class="form-group col-sm-3">
                            <label for="startDate">Датум на пријавување:</label>
                            <input type="date" class="form-control placeholder" id="DateAdded" />
                            <select id="operatorDateAdded">
                                <option>&lt</option>
                                <option>=</option>
                                <option>&gt</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-inline row">
                        <div class="form-group col-sm-3">
                            <label for="clientName">Име на осигуреник:</label>
                            <input type="search" name="clientName" class="input-sm" placeholder="Search by name" id="clientName" />
                        </div>
                        <div class="form-group col-sm-3">
                            <label for="clientLastName">Презиме на осигуреник:</label>
                            <input type="search" name="clientLastName" class="input-sm" placeholder="Search by last name" id="clientLastName" />
                        </div>
                    </div>
                    <div class="form-inline row">
                        <div class="form-group col-sm-3">
                            <label for="insuredName">Име на оштетеник:</label>
                            <input type="search" name="insuredName" class="input-sm" placeholder="Search by name" id="insuredName" />
                        </div>
                        <div class="form-group col-sm-3">
                            <label for="insuredLastName">Презиме на оштетеник:</label>
                            <input type="search" name="insuredLastName" class="input-sm" placeholder="Search by last name" id="insuredLastName" />
                        </div>
                    </div>
                    <div class="form-inline row">
                        <div class="form-group col-sm-3">
                            <label for="totalPrice">Вкупна цена на трошоци:</label>
                            <input type="search" name="totalPrice" class="input-sm" placeholder="Search by Total Cost" id="totalPrice" />
                        </div>
                        <div class="form-group col-sm-3">
                            <input type="radio" name="typeInsurance" value="healthInsurance" id="healthInsurance"> Здравествено осигурување<br>
                            <input type="radio" name="typeInsurance" value="luggageInsurance" id="luggageInsurance">Осигурување на багаж<br>
                        </div>
                    </div>
                </div>
                <br />
                <input id="btnSubmit" class="btn btn-primary btn-material-design-success" value="Search" onclick="SearchFNOL()" type="button" />
                <br />
            </form>
            <div class="row">
                <div class="col-md-offset-11 hover-tooltip">
                    <button type="button" class="btn btn-success btn-circle btn-lg btn-material-design" data-toggle="tooltip" title="Додади нова штета" onclick="@("window.location.href='" + @Url.Action("Index", "FirstNoticeOfLoss") + "'");"><i class="glyphicon glyphicon-plus"></i></button>
                </div>
            </div>
        </div>
        <br />
        <br />
        <br />
        <div class="row">
            <table style="width: 100%;" class="table table-bordered table-hover table-striped" id="tableFNOL">
                <thead>
                    <tr>
                        <th>Број на полиса</th>
                        <th>Име и презиме на осигуреник</th>
                        <th>Име и презиме на оштетениот</th>
                        <th>Сродство на оштетениот со осигуреникот</th>
                        <th>Вкупна цена на трошоците</th>
                        <th>Датум на пријавување</th>
                        <th>Здраствено осигурување ДА/НЕ</th>
                        <th>Осигурување на багаж ДА/НЕ</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script type="text/javascript">

    $(document).ready(function () {
        $(".hover-tooltip button").tooltip('show');
        $("#searchClients").hide();
        $("#searchFNOL").hide();
        $("#tableClients").DataTable().destroy();
        $("#tableClients").DataTable();
        $("#tablePolicies").DataTable().destroy();
        $("#tablePolicies").DataTable();
        $("#tableFNOL").DataTable().destroy();
        $("#tableFNOL").DataTable();
        $("#tableFNOLPolicies").css("display", "none");
    });

    $("#DateI").focusout(function () {
        var Sdat = $("#DateI").val();
        $("#startDate").attr('min', Sdat);
        $("#endDate").attr('min', Sdat);
        $("#DateS").attr('min', Sdat);

    });

    $("#endDate").focusout(function () {
        var Edat = $("#endDate").val();
        $("#DateS").attr('max', Edat);
        $("#startDate").attr('max', Edat);
    });

    function ShowClients() {
        $("#searchPolycies").hide();
        $("#searchFNOL").hide();
        $("#searchClients").show();
        $("#polycies").removeAttr("class");
        $("#clients").attr("class", "active");
        $("#first_notice_of_loss").removeAttr("class");
        $("#clients").attr("class", "active");
    };

    function ShowPolycies() {
        $("#searchPolycies").show();
        $("#searchFNOL").hide();
        $("#searchClients").hide();
        $("#clients").removeAttr("class");
        $("#first_notice_of_loss").removeAttr("class");
        $("#polycies").attr("class", "active");
        $("#tableFNOLPolicies").css("display", "none");
    };


    function ShowFNOL() {
        $("#searchPolycies").hide();
        $("#searchFNOL").show();
        $("#searchClients").hide();
        $("#polycies").removeAttr("class");
        $("#clients").removeAttr("class");
        $("#first_notice_of_loss").attr("class", "active");
    };

    function SearchPolycies() {
        $("#tablePolicies").DataTable().destroy();
        $("#tablePolicies").DataTable({
            dom: "Bfrtip",
            ajax: "@System.Configuration.ConfigurationManager.AppSettings["webpage_url"]/Search/GetPolicies?name=" + $("#namePolicy").val() + "&embg=" + $("#embgPolicy").val() + "&land=" + $("#land").val() + "&address=" + $("#addressPolicy").val() + "&agency=" + $("#agency").val() + "&TypePolicy=" + $("#TypePolycies").val() + "&Country=" + $("#Country").val() + "&startDate=" + $("#startDate").val() + "&endDate=" + $("#endDate").val() + "&dateI=" + $("#dateI").val() + "&dateS=" + $("#dateS").val() + "&operatorStartDate=" + $("#operatorStartDate").val() + "&operatorEndDate=" + $("#operatorEndDate").val() + "&operatorDateI=" + $("#operatorDateI").val() + "&operatorDateS=" + $("#operatorDateS").val(),
            columns: [
               { data: "Polisa_Broj" },
               { data: "Country" },
               { data: "Policy_type" },
               { data: "Zapocnuva_Na" },
               { data: "Zavrsuva_Na" },
               { data: "Datum_Na_Izdavanje" },
               { data: "Datum_Na_Storniranje" },
               {
                   data: "Polisa_Broj",
                   "render": function (data, type, row, meta) {
                       if (type === 'display') {
                           var value = data;
                           return $('<a>')
                               .attr('href', '/Policy/PrintPolicy?id=' + data)
                               .attr('target', '_blank')
                               .attr('class', 'details')
                               .text("Детали")
                               .wrap('<div></div>')
                               .parent()
                               .html();
                       } else {
                           return data;
                       }
                   }
               },
               {
                   data: "Polisa_Id",
                   "render": function (data, type, row, meta) {
                       if (type === 'display') {
                           return $('<a>')
                               .attr('href', 'javascript:;')
                               .attr('class', 'loss')
                               .attr('id', data)
                               .text("Штети")
                               .wrap('<div></div>')
                               .parent()
                               .html();
                       } else {
                           return data;
                       }
                   }
               },
               {
                   data: "Polisa_Id",
                   "render": function (data, type, row, meta) {
                       if (type === 'display') {
                           return $('<a>')
                               .attr('href', '/FirstNoticeOfLoss/Index?policyId=' + data)
                               .attr('class', 'newLoss')
                               .attr('id', data)
                               .text("Пријави штета")
                               .wrap('<div></div>')
                               .parent()
                               .html();
                       } else {
                           return data;
                       }
                   }
               }

            ],
            select: true
        });

        $('#tablePolicies tbody').on('click', 'td .loss', function () {
            var $row = $(this).closest('td');
            var policy_num = $row.children().attr('id');
            CreateFNOLTablePoliciesByPolicyNumber(policy_num);

        });
    };

    function CreateFNOLTablePoliciesByPolicyNumber(policy_number) {
        $("#tableFNOLPolicies").DataTable().destroy();
        $("#tableFNOLPolicies").DataTable({
            dom: "Bfrtip",
            ajax: "@System.Configuration.ConfigurationManager.AppSettings["webpage_url"]/Search/GetFNOLByPolicyNumber?number=" + policy_number,
            columns: [
                    { data: "PolicyNumber" },
                    { data: "InsuredName" },
                    { data: "ClaimantPersonName" },
                    { data: "Claimant_insured_relation" },
                    { data: "AllCosts" },
                    { data: "Date" },
                    { data: "HealthInsurance" },
                    { data: "LuggageInsurance" },
                    {
                        data: "ID",
                        "render": function (data, type, row, meta) {
                            if (type === 'display') {
                                var value = data;
                                return $('<a>')
                                    .attr('href', '/FirstNoticeOfLoss/View?id=' + data)
                                    .attr('target', '_blank')
                                    .attr('class', 'lossDetails')
                                    .text("Детали")
                                    .wrap('<div></div>')
                                    .parent()
                                    .html();
                            } else {
                                return data;
                            }
                        }
                    },
            ],
            select: true
        });
        $("#tableFNOLPolicies").css("display", "block");
    };

    function SearchFNOL() {
        $("#tableFNOL").DataTable().destroy();
        $("#tableFNOL").DataTable({
            dom: "Bfrtip",
            ajax: "@System.Configuration.ConfigurationManager.AppSettings["webpage_url"]/Search/GetFNOL?policyNum" + $("#PolicyNumber").val() + "&clientName=" + $("#clientName").val() + "&clientLastName=" + $("#clientLastName").val() + "&insuredName=" + $("#insuredName").val() + "&insuredLastName=" + $("#insuredLastName").val() + "&totalPrice=" + $("#totalPrice").val() + "&healthInsurance=" + $('#healthInsurance').is(':checked') + "&luggageInsurance=" + $('#luggageInsurance').is(':checked'),
            columns: [
                    { data: "PolicyNumber" },
                    { data: "InsuredName" },
                    { data: "ClaimantPersonName" },
                    { data: "Claimant_insured_relation" },
                    { data: "AllCosts" },
                    { data: "Date" },
                    { data: "HealthInsurance" },
                    { data: "LuggageInsurance" },
                    {
                        data: "ID",
                        "render": function (data, type, row, meta) {
                            if (type === 'display') {
                                var value = data;
                                return $('<a>')
                                    .attr('href', '/FirstNoticeOfLoss/View?id=' + data)
                                    .attr('target', '_blank')
                                    .attr('class', 'lossDetails')
                                    .text("Детали")
                                    .wrap('<div></div>')
                                    .parent()
                                    .html();
                            } else {
                                return data;
                            }
                        }
                    },
            ],
                select: true
        });
    };


    function SearchClients() {
        $("#tableClients").DataTable().destroy();
        var table = $("#tableClients").DataTable({
            dom: "Bfrtip",
            ajax: "@System.Configuration.ConfigurationManager.AppSettings["webpage_url"]/Search/GetUsers?name=" + $("#name").val() + "&lastname" + $("#lastname").val() + "&embg=" + $("#embg").val() + "&email=" + $("#email").val() + "&address=" + $("#address").val() + "&phone=" + $("#phone").val() + "&postal_code=" + $("#postal_code").val() + "&passport=" + $("#passport").val() + "&city=" + $("#city").val(),
            columns: [
                        { data: "Name" },
                        { data: "Lastname" },
                        { data: "SSN" },
                        { data: "Address" },
                        { data: "City" },
                        { data: "Postal_Code" },
                        { data: "Phone_Number" },
                        { data: "Email" },
                        { data: "Passport_Number_IdNumber" },
                        {
                            data: "ID",
                            "render": function (data, type, row, meta) {
                                if (type === 'display') {
                                    return $('<a>')
                                        .attr('href', 'javascript:;')
                                        .attr('class', 'clients')
                                        .attr('id', data)
                                        .text("Полиси за осигуреник")
                                        .wrap('<div></div>')
                                        .parent()
                                        .html();
                                } else {
                                    return data;
                                }
                            }
                        },
                        {
                            data: "ID",
                            "render": function (data, type, row, meta) {
                                if (type === 'display') {
                                    return $('<a>')
                                        .attr('href', 'javascript:;')
                                        .attr('class', 'holders')
                                        .attr('id', data)
                                        .text("Полиси за договорувач")
                                        .wrap('<div></div>')
                                        .parent()
                                        .html();
                                } else {
                                    return data;
                                }
                            }
                        },
            ],
            select: true
        });
        $('#tableClients tbody').on('click', 'td .clients', function () {
            var $row = $(this).closest('td');
            var policy_num = $row.children().attr('id');
            CreateFNOLTablePoliciesByPolicyNumber(policy_num);

        });

        $('#tableClients tbody').on('click', 'td .holders', function () {
            var $row = $(this).closest('td');
            var policy_num = $row.children().attr('id');
            CreateFNOLTablePoliciesByPolicyNumber(policy_num);

        });
    };

    function CreatePoliciesByPolicyNumber(policy_number) {
        $("#tableFNOLPolicies").DataTable().destroy();
        $("#tableFNOLPolicies").DataTable({
            dom: "Bfrtip",
            ajax: "@System.Configuration.ConfigurationManager.AppSettings["webpage_url"]/Search/GetFNOLByPolicyNumber?number=" + policy_number,
            columns: [
                    { data: "PolicyNumber" },
                    { data: "InsuredName" },
                    { data: "ClaimantPersonName" },
                    { data: "Claimant_insured_relation" },
                    { data: "AllCosts" },
                    { data: "Date" },
                    { data: "HealthInsurance" },
                    { data: "LuggageInsurance" },
                    {
                        data: "ID",
                        "render": function (data, type, row, meta) {
                            if (type === 'display') {
                                var value = data;
                                return $('<a>')
                                    .attr('href', '/FirstNoticeOfLoss/View?id=' + data)
                                    .attr('target', '_blank')
                                    .attr('class', 'lossDetails')
                                    .text("Детали")
                                    .wrap('<div></div>')
                                    .parent()
                                    .html();
                            } else {
                                return data;
                            }
                        }
                    },
            ],
        select: true
    });
            $("#tableFNOLPolicies").css("display", "block");
    }
</script>





